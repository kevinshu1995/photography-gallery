name: Scheduled Vercel Deployment

on:
  schedule:
    # æ¯ 2 å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼ˆUTC æ™‚é–“ï¼‰
    - cron: '0 */2 * * *'
  push:
    branches:
      - master
  workflow_dispatch:
    # æ”¯æ´æ‰‹å‹•è§¸ç™¼ä»¥ä¾¿æ¸¬è©¦

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: å–å¾—ç•¶å‰ commit SHA èˆ‡ message
        id: current
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)

          echo "sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

          # ä½¿ç”¨ heredoc æ ¼å¼è™•ç†å¤šè¡Œ commit message
          {
            echo "message<<EOF"
            echo "$COMMIT_MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "ğŸ“ ç•¶å‰ commit SHA: $CURRENT_SHA"
          echo "ğŸ“ Commit message:"
          echo "$COMMIT_MSG"

      - name: å–å¾—ä¸Šæ¬¡éƒ¨ç½²çš„ commit SHA
        id: last-deploy
        uses: actions/cache/restore@v4
        with:
          path: .last-deploy-sha
          key: last-deploy-commit-${{ github.ref }}

      - name: è®€å–ä¸Šæ¬¡éƒ¨ç½²çš„ SHA
        id: last
        run: |
          if [ -f .last-deploy-sha ]; then
            LAST_SHA=$(cat .last-deploy-sha)
            echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ ä¸Šæ¬¡éƒ¨ç½² commit SHA: $LAST_SHA"
          else
            echo "sha=" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç„¡ä¸Šæ¬¡éƒ¨ç½²è¨˜éŒ„ï¼ˆé¦–æ¬¡åŸ·è¡Œï¼‰"
          fi

      - name: æ¯”å° commit SHA ä¸¦æ±ºå®šæ˜¯å¦éƒ¨ç½²
        id: should-deploy
        run: |
          CURRENT="${{ steps.current.outputs.sha }}"
          LAST="${{ steps.last.outputs.sha }}"
          COMMIT_MSG="${{ steps.current.outputs.message }}"

          # æª¢æŸ¥ commit message æ˜¯å¦åŒ…å« [skip_ci]
          if echo "$COMMIT_MSG" | grep -q "\[skip_ci\]"; then
            echo "ğŸš« åµæ¸¬åˆ° [skip_ci] æ¨™ç±¤"
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "reason=Commit message åŒ…å« [skip_ci]" >> $GITHUB_OUTPUT
            echo "skip_ci=true" >> $GITHUB_OUTPUT
          elif [ -z "$LAST" ]; then
            echo "æ±ºç­–: é¦–æ¬¡åŸ·è¡Œï¼Œå°‡è§¸ç™¼éƒ¨ç½²"
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "reason=é¦–æ¬¡åŸ·è¡Œ" >> $GITHUB_OUTPUT
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT" != "$LAST" ]; then
            echo "æ±ºç­–: åµæ¸¬åˆ°æ–° commitï¼Œå°‡è§¸ç™¼éƒ¨ç½²"
            echo "âœ¨ æ–°è®Šæ›´: $LAST -> $CURRENT"
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "reason=åµæ¸¬åˆ°æ–° commit" >> $GITHUB_OUTPUT
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          else
            echo "æ±ºç­–: ç„¡æ–°è®Šæ›´ï¼Œè·³ééƒ¨ç½²"
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "reason=ç„¡æ–°è®Šæ›´" >> $GITHUB_OUTPUT
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi

      - name: è§¸ç™¼ Vercel éƒ¨ç½²
        if: steps.should-deploy.outputs.deploy == 'true'
        id: deploy
        run: |
          echo "ğŸš€ æ­£åœ¨è§¸ç™¼ Vercel éƒ¨ç½²..."

          RESPONSE=$(curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP_CODE:%{http_code}" \
            -s)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

          echo "HTTP Status Code: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… Vercel éƒ¨ç½²å·²æˆåŠŸè§¸ç™¼"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Vercel éƒ¨ç½²è§¸ç™¼å¤±æ•— (HTTP $HTTP_CODE)"
            echo "å›æ‡‰å…§å®¹: $BODY"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: å„²å­˜æ–°çš„éƒ¨ç½² commit SHAï¼ˆæˆåŠŸéƒ¨ç½²ï¼‰
        if: steps.should-deploy.outputs.deploy == 'true' && steps.deploy.outputs.status == 'success'
        run: |
          echo "${{ steps.current.outputs.sha }}" > .last-deploy-sha
          echo "ğŸ’¾ å·²å„²å­˜æ–°çš„éƒ¨ç½² commit SHA"

      - name: å„²å­˜ commit SHAï¼ˆskip_ciï¼‰
        if: steps.should-deploy.outputs.skip_ci == 'true'
        run: |
          echo "${{ steps.current.outputs.sha }}" > .last-deploy-sha
          echo "ğŸ’¾ å·²å„²å­˜ skip_ci commit SHAï¼ˆé¿å…é‡è¤‡æª¢æŸ¥ï¼‰"

      - name: æ›´æ–° cacheï¼ˆæˆåŠŸéƒ¨ç½²ï¼‰
        if: steps.should-deploy.outputs.deploy == 'true' && steps.deploy.outputs.status == 'success'
        uses: actions/cache/save@v4
        with:
          path: .last-deploy-sha
          key: last-deploy-commit-${{ github.ref }}

      - name: æ›´æ–° cacheï¼ˆskip_ciï¼‰
        if: steps.should-deploy.outputs.skip_ci == 'true'
        uses: actions/cache/save@v4
        with:
          path: .last-deploy-sha
          key: last-deploy-commit-${{ github.ref }}

      - name: ç”ŸæˆåŸ·è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“Š å®šæ™‚éƒ¨ç½²åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Commit è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "- **ç•¶å‰ commit**: \`${{ steps.current.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit message**:" >> $GITHUB_STEP_SUMMARY
          echo '  ```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.current.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo '  ```' >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.last.outputs.sha }}" ]; then
            echo "- **ä¸Šæ¬¡éƒ¨ç½²**: \`${{ steps.last.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ä¸Šæ¬¡éƒ¨ç½²**: ç„¡ï¼ˆé¦–æ¬¡åŸ·è¡Œï¼‰" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ éƒ¨ç½²æ±ºç­–" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.should-deploy.outputs.skip_ci }}" = "true" ]; then
            echo "- **æ±ºå®š**: ğŸš« è·³ééƒ¨ç½²ï¼ˆåµæ¸¬åˆ° [skip_ci]ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- **åŸå› **: ${{ steps.should-deploy.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‹€æ…‹**: âœ… å·²æ›´æ–° commit SHA è¨˜éŒ„ï¼ˆé¿å…é‡è¤‡æª¢æŸ¥ï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.should-deploy.outputs.deploy }}" = "true" ]; then
            echo "- **æ±ºå®š**: âœ… è§¸ç™¼éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
            echo "- **åŸå› **: ${{ steps.should-deploy.outputs.reason }}" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.deploy.outputs.status }}" = "success" ]; then
              echo "- **ç‹€æ…‹**: ğŸš€ Vercel éƒ¨ç½²å·²æˆåŠŸè§¸ç™¼" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **ç‹€æ…‹**: âŒ Vercel éƒ¨ç½²è§¸ç™¼å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **æ±ºå®š**: â­ï¸ è·³ééƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
            echo "- **åŸå› **: ${{ steps.should-deploy.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â° åŸ·è¡Œæ™‚é–“" >> $GITHUB_STEP_SUMMARY
          echo "- **UTC**: $(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

          TRIGGER_TYPE="${{ github.event_name }}"
          if [ "$TRIGGER_TYPE" = "workflow_dispatch" ]; then
            echo "- **è§¸ç™¼æ–¹å¼**: ğŸ–±ï¸ æ‰‹å‹•è§¸ç™¼" >> $GITHUB_STEP_SUMMARY
          elif [ "$TRIGGER_TYPE" = "push" ]; then
            echo "- **è§¸ç™¼æ–¹å¼**: ğŸ“ Push åˆ° master åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          elif [ "$TRIGGER_TYPE" = "schedule" ]; then
            echo "- **è§¸ç™¼æ–¹å¼**: â° å®šæ™‚æ’ç¨‹" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **è§¸ç™¼æ–¹å¼**: $TRIGGER_TYPE" >> $GITHUB_STEP_SUMMARY
          fi
